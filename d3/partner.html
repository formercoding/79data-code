<!DOCTYPE html>
<html>
<head>
	<title>partner relative</title>
</head>
<body>
<svg></svg>
<script src="d3v4/d3.js"></script>
<script>

var svg = d3.select("svg")
			.attr("width", 1000)
			.attr("height", 500);
    width = svg.attr("width"),
    height = svg.attr("height");
var simulation = d3.forceSimulation()
	//.force("x", d3.forceX(1000).strength(-0.5)) // x,y 设置中心位置
	//.force("y", d3.forceY(500).strength(-0.5))
    .force("link", d3.forceLink().id(function(d) { return d.id; }))
    //.force("charge", d3.forceManyBody())
    .force("charge", d3.forceCollide(100))
    .force("center", d3.forceCenter(width / 2, height / 2));

console.log(d3.forceManyBody().distanceMin);
d3.json("miserables.json", function(error, graph) {
  if (error) throw error;

  simulation
  	  .alpha(0.2)  // alpha是动画的冷却系数，运动过程中会不断减小，直到小于0.005为止，此时动画会停止 
      .nodes(graph.nodes)
      .on("tick", ticked);
  simulation.force("link")
      .links(graph.links)

function ticked() {
	var i = 0;
	var links = d3.select("svg").selectAll(".link").data(graph.links, function(d) { return ++i;});
    var enterLinks = links.enter()
  		/*.append("line")
  		.attr("stroke", "#d1b5cf")
  		.attr("class", "link")
  		.attr("x1", function(d) {
  			return d.target.x;
  		})
  		.attr("y1", function(d) {
  			return d.target.y;
  		})
  		.attr("x2", function(d) {
  			return d.source.x;
  		})
  		.attr("y2", function(d) {
  			return d.source.y;
  		});*/
      .append("path")
      .attr("stroke", "#d1b5cf")
      .attr("class", "link")
      .attr("d", function(d) {
        var x1 = d.target.x;
        var y1 = d.target.y;
        var x2 = d.source.x;
        var y2 = d.source.y;
        var slopy,cosy,siny;  
        var Par=10.0;  
        var x3,y3;  
        slopy=Math.atan2((y1-y2),(x1-x2));     
        cosy=Math.cos(slopy);     
        siny=Math.sin(slopy);   
         
        path="M"+x1+","+y1+" L"+x2+","+y2;  
             
        x3=(Number(x1)+Number(x2))/2;  
        y3=(Number(y1)+Number(y2))/2;  
    
        path +=" M"+x3+","+y3;  
          
        path +=" L"+(Number(x3)+Number(Par*cosy-(Par/2.0*siny)))+","+(Number(y3)+Number(Par*siny+(Par/2.0*cosy)));  
    
        path +=" M"+(Number(x3)+Number(Par*cosy+Par/2.0*siny)+","+ (Number(y3)-Number(Par/2.0*cosy-Par*siny)));  
        path +=" L"+x3+","+y3;  
    
        return path;  
      })

  		

    var exitLink = links.exit().remove();

    var nodes = d3.select("svg").selectAll(".node").data(graph.nodes, function(d) {return ++i;
    });


  	var enterNode =  nodes.enter()
  		.append("circle")
  		.attr("fill", function(d) {
        //console.log(d.id);
        if (d.id == "xiaoluobo") {
          return "#e281e3";
        } else {
          return "#91b8ff";
        }
      })
  		.attr("class", "node")
  		.attr("cx", function(d) {
  			return d.x;
  		})
  		.attr("cy", function(d) {
  			return d.y;
  		})
  		.attr("r", function(d) {
  			return 30;
  		});

    var exitNode = nodes.exit().remove();


    var texts = d3.select("svg").selectAll(".text").data(graph.links, function(d) {return ++i;
    });

  	var enterText =  texts.enter()
  		.append("text")
  		.attr("class", "text")
      .attr("fill", "#d1b5cf")
  		.attr("x", function(d) {
  			return (d.source.x + d.target.x) / 2;
  		})
  		.attr("y", function(d) {
  			return (d.source.y + d.target.y) / 2;
  		})
  		.text(function(d) {
  			return d.value;
  		})
      .attr("transform", function(d) {
        var x = Math.ceil((d.source.x + d.target.x) / 2);
        var y = Math.ceil((d.source.y + d.target.y) / 2);
        var angle = Math.atan((d.source.y - d.target.y) / (d.source.x - d.target.x)) * 360 / (2 * Math.PI);
          return "rotate(" + angle + "," + x + "," + y + ")";
      })

    var exitText = texts.exit().remove();

    var nodeTexts = d3.select("svg").selectAll(".node-text").data(graph.nodes, function(d) {return ++i;
    });

    var enterNodeTexts =  nodeTexts.enter()
  		.append("g");
  		

      enterNodeTexts.each(function(d, i) {
        var line = Math.ceil(d.id.length / 5);
        for(var j = 0; j < line; j++) {
          d3.select(this).append("text")
              .attr("fill", "#fff")
              .attr("x", function() {
                return d.x - 20 ;
              })
              .attr("y", function() {
                return d.y + j * 15;
              })
              .text(function() {
                return d.id.slice(j * 5, j * 5 + 5);
              }) 
          } 
      })

    var exitNodeTexts = nodeTexts.exit().remove();





  		
}
  d3.select("svg")
      .call(d3.drag()
          //.container(svg)
          .subject(dragsubject)
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

  /*function ticked() {
    drawLink();

    //graph.nodes.forEach(drawNode);

  }*/

function dragsubject() {
  return simulation.find(d3.event.x, d3.event.y);
}

function dragstarted() {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  d3.event.subject.fx = d3.event.subject.x;
  d3.event.subject.fy = d3.event.subject.y;
}

function dragged() {
  d3.event.subject.fx = d3.event.x;
  d3.event.subject.fy = d3.event.y;
}

function dragended() {
  if (!d3.event.active) simulation.alphaTarget(0);
  d3.event.subject.fx = null;
  d3.event.subject.fy = null;
}
});

/*function drawLink() {
  d3.select("svg").selectAll(".link")
  		.data(graph.links)
  		.append("line")
  		.attr("class", "link")
  		.attr("x1", function(d) {
  			return d.target,x;
  		})
  		.attr("y1", function(d) {
  			return d.target.y;
  		})
  		.attr("x2", function(d) {
  			return d.source.x;
  		})
  		.attr("y2", function(d) {
  			return d.source.y;
  		})
}*/

/*function drawText(d) {
  context.fillText(d.value, (d.source.x + d.target.x) / 2, (d.source.y + d.target.y) / 2);
}

function drawNode(d) {
  context.moveTo(d.x + 10, d.y);
  context.arc(d.x, d.y, 10, 0, 2 * Math.PI);
}

function drawName(d) {
  context.moveTo(d.x + 10, d.y);
  context.arc(d.x, d.y, 10, 0, 2 * Math.PI);
}*/

</script>
</body>
</html>